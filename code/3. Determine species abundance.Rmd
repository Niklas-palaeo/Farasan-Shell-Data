---
title: "Ranks and dominant species"
author: "Niklas Hausmann"
date: "13/03/2020"
output: html_document
---
## Introduction
To determine the dominant species at all sites, we make use of the shell weight dataframe `SW` from the **Basic Shell Information.Rmd** file. If you don't already have this dataframe, you can run all steps below

```{r message=FALSE, warning=FALSE}

source('Farasan Database.R')
SW <- data.frame()#real dataframe
f <- data.frame()#temporary dataframe only used in loop
for (i in 1:length(Species))  {
  for (j in 1:length(Species[[i]]))  {
    for (k in 1:length(Species[[i]][[j]])) {
      f <-
        data.frame(
          c(as.character(names(Species[i]))),
          c(as.character(names(Species[[i]][j]))),
          c(as.character(names(Species[[i]][[j]][k]))),
          as.numeric(Species[[i]][[j]][[k]])
        )
      colnames(f) <- c('Site', 'Sample', 'Species', 'Weight')
      SW <- rbind(SW, f)
    }
  }
}

#Some names are duplicates in the raw files, so they are cleaned up and aggregated
source('Replacement.R')
SW$Speciesname <- unlist(SW$Speciesname) #before we aggregate, we need to unlist the new name (not sure why that column turned into a list, but it did, and it messes with the aggregation step, which oddly enough needs to be aggregated by a list?)
SW <- aggregate(SW[,4], by=list(SW$Speciesname, SW$Sample, SW$Site),FUN=sum)
SW <- data.frame(Site=SW$Group.3, Sample=SW$Group.2, Weight=SW$x, Speciesname=SW$Group.1) #here we just rename the columns

rm(f, i, j, k,Apertures,Sites,Species)
SW$Weight[SW$Weight == 0.5] <-
  0.25 #Change 0.5 weights to 0.25 weights

SW <- spread(SW,
             Speciesname, Weight,
             fill = 0) # Because not all bulk samples included all shell species available around Farasan, they show `NA` in those fields. To better work with these instances, we had to set their weight value to 0.
SW <- aggregate(SW[, 4:154], by = list(SW$Site), FUN = sum)
colnames(SW)[1] <- c("Site")
SW[38, 2:152] <-
  SW[SW$Site == "JW1727_A", 2:152] + SW[SW$Site == "JW1727_B", 2:152] #Sum up each columns' values for species weight
SW <- rbind(SW[1:38, ], SW[40:49, ]) #removing the row for column B
levels(SW$Site) <-
  c(levels(SW$Site), "JW1727")    # adding a new level
SW[38, 1] <-
  "JW1727" #renaming the row of column A to the site's name
library(janitor)
SW <-  add_totals_col(SW)
```


## Species abundances across sites
For the analysis of the shell species' weight-percentages and their individual ranks (with rank 1 for the most common species) at each site, we make use of the `BiodiversityR`-package. For that we first need to move the column with site names, because `BiodiversityR` doesn't know what to do with those. For convenience they are moved into the rownames. `BiodiversityR` also requires integers to work. Our dataset uses decimal numbers, so we need to round these weights to the nearest gram. 

```{r}
rownames(SW) <- SW[,1]
SW <- round(SW[,2:152])#this step also drops the sites and the total weights in the last column of SW
```

In the next step, we will determine the ranks for each row (i.e. site) in a for-loop and using the `rankabundance` function in the [`BiodiversityR`](https://rdrr.io/cran/BiodiversityR/) package.

```{r message=FALSE, warning=FALSE}
#library(BiodiversityR) I am struggling to load this onto the codeocean virtual machine, so I extracted the 'rankabunance' function and made a local rankabundance.R file. DON'T LET THIS KEEP YOU FROM CHECKING OUT THE BIODIVERSITYR PACKAGE. It is amazing!
source('rankabundance.R')

Ranks <- data.frame() #main dataframe
Rank <- data.frame() #single site dataframe used temporarily for each row's loop

for (i in 1:length(SW[,1])) {
  
  Rank<- rankabundance(SW[i,])#make ranking of species abundance. This step will produce a lof of NaNs but that is ok
  Rank <- subset(Rank, Rank[,2] != 0, select=c(rank, abundance, proportion, logabun)) #remove unneccesary colums and rows with species = 0
  Rank <- data.frame(Rank,Site=rep(rownames(SW[i,]),c(length(Rank[,1]))), Species=rownames(Rank))
  
  Ranks <- rbind(Ranks,Rank)
}

rm(Rank,i)#no need for this after the loop is finished
```

The results are given for each species in each midden. The species that do not occur in a specific midden were dropped, as well as some of the statistical data that `rankabundance` produces. In the end, we are left with the species, it's rank within the site, the abundance in grams and as logarythm, the proportion in %, and the site they belong to.


```{r}
Ranks[1:2,1:5]
```

To only look at the dominant species' weight for each site, we `spread` this dataframe and remove the species that are not dominant. This selection of 'dominant' is done manually and is mainly based on the proportion (>10%) of a species overall, but we also included species that are dominant in only one or two sites (i.e. Pleuroploca trapezium).

```{r}
Spreadranks <- spread(Ranks,Species,proportion,fill = 0) 
Spreadranks <- Spreadranks[,c('Site','Conomurex fasciatus',
               'Pinctada species', 
               'Chicoreus species', 
               'Chama pacifica', 
               'Spondylus spinosus', 
               'Strombus tricornis',
               'Plicatula plicata',
               'Arca species',
               'Pleuroploca trapezium',
               'Ostrea species')] #this step cuts down a lot of the columns (species) and leaves only the important ones.

Table2 <- aggregate(Spreadranks[,2:11], by=list(Spreadranks$Site),FUN=sum) #this step is necessary to combine all of a site's rows into one row. Before we had one row per site and species, but they can easily be added up with the aggregate function (sum).
rm(Ranks,Spreadranks)
names(Table2)[1] <- "Site"

head(Table2)
```

## Illustrating species abundance across sites (Fig.4)
To show these data more clearly, we created Figure 4, which shows the species distribution by site and clustered by bay area.
However, first we need to change the structure of the `Table2` dataframe using the `gather` function, which is part of the [Tidyverse](https://www.tidyverse.org) package.

```{r}
# Transform data in a tidy format (long format)
library(tidyverse)
Fig4Dat <- gather(Table2,'Conomurex fasciatus',
                  'Pinctada species', 
                  'Chicoreus species', 
                  'Chama pacifica', 
                  'Spondylus spinosus', 
                  'Strombus tricornis',
                  'Plicatula plicata',
                  'Arca species',
                  'Pleuroploca trapezium',
                  'Ostrea species',key = "Species", value="Weight") #This step takes each row and distributes the individual values for weight it into several new rows, which are then structured by a key variable (Species).

#Add areas to individual plots
Fig4Dat <- data.frame(Area=c("Khur Maadi","Khur Maadi","Khur Maadi","Khur Maadi","Khur Maadi","Khur Maadi", "Khur Maadi","Khur Maadi","Khur Maadi","Khur Maadi","Khur Maadi","Khur Maadi","Khur Maadi","Khur Maadi","Khur Maadi","Khur Maadi",
                             "Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West", "Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West",
                             "Janaba East","Janaba East","Janaba East","Janaba East","Janaba East"),Fig4Dat)
#There is a smarter way of doing this, but I couldn't get it to work properly, so copy&paste it is!
```
```{r}
head(Fig4Dat)
```



With the data restructured, we will make a stacked bar chart for each area using ggplot, and add them together into one figure (Fig. 4) using `patchwork`.

```{r fig.height=4, fig.width=12, message=FALSE, warning=FALSE}

library("ggplot2")
library("RColorBrewer")
library("patchwork")
KM <- ggplot(Fig4Dat[Fig4Dat$Area=="Khur Maadi",]) +      
  geom_bar(aes(x=Site, y=Weight, fill=Species), position="fill", stat="identity") +
  theme_minimal() +   scale_fill_brewer(palette = "Paired") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), legend.position = "none")+xlab("")+
  scale_y_continuous(labels=c("0%","25%","50%","75%","100%"))

JW <- ggplot(Fig4Dat[Fig4Dat$Area=="Janaba West",]) +          
  geom_bar(aes(x=Site, y=Weight, fill=Species), position="fill", stat="identity") +
  theme_minimal() +   scale_fill_brewer(palette = "Paired")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),legend.position = "none")+xlab("")+ylab("")


JE <- ggplot(Fig4Dat[Fig4Dat$Area=="Janaba East",]) +         
  geom_bar(aes(x=Site, y=Weight, fill=Species), position="fill", stat="identity") +
  theme_minimal() +   scale_fill_brewer(palette = "Paired")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +xlab("")+ylab("")



Fig4 <- KM + JW + JE + 
        plot_layout(widths = c(3,5,1))+
        plot_annotation(
        title = 'Species composition by site',
        subtitle = 'Percentages are based on weight')
Fig4

setwd("~/Farasan-Shell-Data-master/results") #Remember to change the file path so that it fits with your system
ggsave("Figure_4.png", height = 100, width = 300, units = "mm")
```



## Dominant species by bay area (Fig.5)

To show the general abundances of species in different areas around Farasan, we structured the shell weight data by areas instead of sites. This created the new dataframe `SWA`.

```{r}
SWA <- data.frame(Area=c("Khur Maadi","Khur Maadi","Khur Maadi","Khur Maadi","Khur Maadi","Khur Maadi", "Khur Maadi","Khur Maadi","Khur Maadi","Khur Maadi","Khur Maadi","Khur Maadi","Khur Maadi","Khur Maadi","Khur Maadi","Khur Maadi","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West", "Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba West","Janaba East","Janaba East","Janaba East","Janaba East","Janaba East"),Site=row.names(SW)) 

SWA <- cbind(SWA,SW)#SW could have been included in the dataframe build above, but it introduces '.' between species names, which I didn't want.

SWA <- aggregate(SWA[,3:153], by=list(SWA$Area), FUN = sum) #this aggregates all weights by Area
SWA<-SWA[dim(SWA)[1]:1,] #Not sure how this works but it reverses the order of the rows

rownames(SWA) <- SWA[,1]  #Again we prepare the data by moving the information on areas into the rownames
SWA <- SWA[,2:152] #and dropping the values

#If we hadn't already rounded the values above, this would also be necessary at this point as well.
#SWA <- round(SWA[,2:171])
```

Similar to above, we use the `BiodiversityR` package to rank the species by weight. This time the ranks apply to the bay area as a whole.

```{r message=FALSE, warning=FALSE}
AreaRanks <- data.frame()
AreaRank <- data.frame()

for (i in 1:length(SWA[,1])) {
  
  AreaRank<- rankabundance(SWA[i,])
  AreaRank <- subset(AreaRank, AreaRank[,2] != 0, select=c(rank, abundance, proportion)) #remove unneccesary colums and rows with species = 0
  AreaRank <- data.frame(AreaRank,Area=rep(rownames(SWA[i,]),c(length(AreaRank[,1]))), Species=rownames(AreaRank))
  
  AreaRanks <- rbind(AreaRanks,AreaRank)
}
```

We then added a `Dominant` column at the back, where species are considered dominant when they are above 2%. This is an arbitrary number. Of course C. fasciatus is THE dominant species in all areas, but the species above 2% are still occurring in respectable numbers compared to many other species.

```{r}
AreaRanks$Dominant <- ifelse(AreaRanks$proportion <2, "Marginal","Dominant")
```

Lastly, to create Figure 5, we use the `ggplot2` package


```{r message=FALSE, warning=FALSE,fig.width=10,fig.height=6}
library(ggplot2)
library(viridis)
library(viridisLite)
library(cowplot)
library(ggrepel)

Fig5 <- ggplot(AreaRanks, aes(x=rank,y=proportion, group=Area))+
  geom_path(size=0.5)+
  geom_point(aes(color = Dominant), show.legend = FALSE)+
  scale_color_manual(values=c(viridis_pal()(60)[30],"black"))+ xlim(0, 60)+ ylim(0, 100)+
  theme(legend.position = "none")+facet_wrap(~Area,nrow=1)+theme_half_open()+
  theme(strip.background = element_rect(colour = "black", fill = "white"))+
  theme(strip.text.x = element_text(face = "bold"))+
  geom_text_repel(
    data=subset(AreaRanks,proportion>2),
    aes(label= Species, color=factor(Species)),
    xlim = c(20,60), ylim=c(10,NA),
    colour = viridis_pal()(60)[30],
    direction= "y",
    hjust=0,
    segment.size = 0.1, fontface= 'bold'
  )


library(patchwork)
Fig5 + plot_annotation(
  title = 'Species abundances between areas',
  subtitle = 'Named species are above 2% in percentage by weight')
setwd("~/Farasan-Shell-Data-master/results")
ggsave("Figure_5.png", height = 150, width = 300, units = "mm")
```
