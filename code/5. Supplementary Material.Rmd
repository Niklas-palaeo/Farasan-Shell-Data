---
title: "Supplementary Material"
author: "Niklas Hausmann"
date: "13/03/2020"
output: html_document
---

# Introduction
In this file, we describe the process of creating the figures included in the supplementary Material of the paper. These figures are:

1. **Aperture sizes** for all sites by bulk sample and for the entire site
2. **Aperture sizes** by bulk sample compared to changes in **Richness**, **Simpson Index**, and **Percentage of *C. fasciatus***
3. **Species composition** by weight percentage and ranks on site-level.

The information required to create these figures comes from the 'Farasan Database.R' file, which is why we will 'source' this first, together with some additional files, which we used before in the other documents.

```{r message=FALSE, warning=FALSE}
source("Farasan Database.R")
source("R_rainclouds.R")
source("summarySE.R")
library(patchwork)
library(viridis)
library(ggrepel)
library(cowplot)

```





# 1. Aperture sizes
First we will want to get the aperture data from the 'Aperture' list into a dataframe, called 'Aps'. This simple dataframe contains all the information we need, with each individual aperture measurement in mm and its corresponding site and sample number.


```{r}
Aps <- data.frame()
f <- data.frame()

for (i in 1:length(Apertures))  {
  for (j in 1:length(Apertures[[i]]))  {
    if ("Strombus.fasciatus..............Born.1778..Aperture" %in% names(Apertures[[i]][[j]]) == FALSE) {
      next
    }
    f <-
      data.frame(c(as.character(names(Apertures[i]))), c(as.character(names(Apertures[[i]][j]))), Apertures[[i]][[j]][["Strombus.fasciatus..............Born.1778..Aperture"]])
    colnames(f) <- c('Site', 'Sample', 'Aperture')
    Aps <- rbind(Aps, f)
  }
}

rm(f, i, j)
head(Aps)
```

In addition, we want to look at the changing mean aperture size throughout the column, for which we will need to calculate the average size per sample.

```{r message=FALSE, warning=FALSE}
ApsMeans <-summarySE(na.omit(Aps), measurevar = "Aperture", groupvars = c("Sample"))
Sitecol <-tbl_df(Aps) %>% 
  group_by(., Sample) %>% 
  summarise(., Site = first(Site)) #the first step, dropped the Site information, so we will add that back in by first making this table showing samples and sites, followed by adding them to the summarised data below. 

ApsMeans <- cbind(Sitecol[, 2],ApsMeans[,1:5]) %>% 
            na.omit() #The reason why we are using pipes (%>%) here and above is because that is what the solution we randomly found online was using, and we didn't dare to change it up. 
rm(Sitecol)
head(ApsMeans)
```

Now that all data is available, we can use a for-loop that repeats as often as the number of sites in the `Sites` list and each time accesses the bulk sample data ('PLOT1') together with each samples mean value, which we use to draw a line from one sample to another. In `PLOT2` we look at the same data, but group them by `Site`. Using the `patchwork` package, we simply add them together, before saving them.


```{r fig.height=5, fig.width=3, message=FALSE, warning=FALSE}

#First we make a new folder for the supplementary data
dir.create(file.path(dirname("~/capsule/results/."), "Supplementary Material"))
#and a folder for all the figures baout aperture sizes 
dir.create(file.path(dirname("~/capsule/results/Supplementary Material/."), "1. Aperture Sizes"))


for (i in 1:length(Sites[])) {
  PLOT1<- ggplot(Aps[Aps$Site==names(Sites[i]),], aes(
    x = Sample,
    y = Aperture,
    fill = Site,
    colour = Site
  )) +
    geom_flat_violin(
      position = position_nudge(x = +0.25, y = 0),
      adjust = 0.75,
      trim = FALSE,
      alpha = .99
    ) +
    geom_point(position = position_jitter(width = .1), 
               size = 0.05
    ) +
    geom_boxplot(
      position = position_nudge(x = +0.25, y = 0),
      aes(x = Sample, y = Aperture),
      outlier.shape = NA,
      alpha = 0.3,
      width = .1,
      colour = "BLACK"
    ) +
    ylab('Aperture size') + xlab('Sample Number') + coord_flip() + guides(fill = FALSE, colour = FALSE) +  ylim(10, 35)+
    geom_line(
      data = ApsMeans[ApsMeans$Site==names(Sites[i]),],
      position = position_nudge(x = +0.25, y = 0),
      aes(x = Sample, y = Aperture_mean, group = Site),
      inherit.aes = FALSE,
      linetype = 3
    ) +
    scale_color_manual(values="#DD8D29")+ scale_fill_manual(values="#DD8D29")+
    theme(axis.title.x  = element_blank()) +theme_light()+
    theme(axis.title.x=element_blank(),axis.text.x=element_blank(),axis.ticks.x=element_blank())+
    ggtitle(names(Sites[i]))
  
  
  PLOT2 <- ggplot(Aps[Aps$Site==names(Sites[i]),], aes(
    x = Site,
    y = Aperture,
    fill = Site,
    colour = Site
  )) +
    geom_flat_violin(
      position = position_nudge(x = +0.25, y = 0),
      adjust = 0.75,
      trim = FALSE,
      alpha = .99
    ) +
    geom_point(position = position_jitter(width = .1),
               size = 0.05
    ) +
    geom_boxplot(
      position = position_nudge(x = +0.25, y = 0),
      aes(x = Site, y = Aperture),
      outlier.shape = NA,
      alpha = 0.3,
      width = .1,
      colour = "BLACK"
    ) +
    ylab('Aperture size') + coord_flip() + guides(fill = FALSE, colour = FALSE) +   ylim(10, 35)+
    scale_color_manual(values="#DD8D29")+ scale_fill_manual(values="#DD8D29")+
    theme_light()+theme(axis.title.y=element_blank(),axis.text.y=element_blank(),axis.ticks.y=element_blank())
  
PLOT1/PLOT2+plot_layout(ncol = 1, heights = c(0.8, 0.2))

setwd("~/capsule/results/Supplementary Material/1. Aperture Sizes")
ggsave(paste0("Aperture_Plot_",names(Sites[i]),".pdf"),height = 10, width = 5)

}

PLOT1/PLOT2+plot_layout(ncol = 1, heights = c(0.8, 0.2))



```

# 2. Aperture sizes compared to species composition and diversity indices
To compare changes in aperture with changes in species composition and especially the abundance of *C. fasciatus*, we need to add a bit more information on the site composition. First, we will need a dataframe containing the species weight (`SW`) and aggregate it to `sample` level. 


```{r Get weights by species}
#SW####
SW <- data.frame()#real dataframe
f <- data.frame()#temporary dataframe only used in loop
for (i in 1:length(Species))  {
  for (j in 1:length(Species[[i]]))  {
    for (k in 1:length(Species[[i]][[j]])) {
      f <-
        data.frame(
          c(as.character(names(Species[i]))),
          c(as.character(names(Species[[i]][j]))),
          c(as.character(names(Species[[i]][[j]][k]))),
          as.numeric(Species[[i]][[j]][[k]])
        )
      colnames(f) <- c('Site', 'Sample', 'Species', 'Weight')
      SW <- rbind(SW, f)
    }
  }
}


rm(f, i, j, k)
SW$Weight[SW$Weight == 0.5] <-
  0.25 #Change 0.5 weights to 0.25 weights

#Something funny happens where in the spread step, we loose the 'Site' information. This has to do with unique combination of keys per row required for the spread function to work. However, we want to group the speciesnames, so that the weights can be combined. There is, as always, an elegant way around this, however, we just decided to do the same step with the original species description and take the results information about the site. This is possible, because the order of samples is unchanged.

SW_old <- spread(SW,
             Species, Weight, #here we just want the information about sites
             fill = 0)

source('Replacement.R') #then we update the names
SW <- spread(SW,
             Speciesname, Weight, #spread the dataframe with the new names, resulting in many more rows because now one species might have duplicate weights, which were thought to be individual species before.
             fill = 0)

SW <- aggregate(SW[, 4:155], by = list(SW$Sample), FUN = sum) #so we aggregate those weights, which leaves us without the site information.

SW$Site <- SW_old$Site  #But we get the information from the dataframe with the old names again.
rm(SW_old)
#Then we just need to move that column to the beginning
SW <- SW[,c(154,1:153)]
#and give the sample column back its name
colnames(SW)[2] <- c("Sample")
```

We will use these weights to calculate the [Simpson Index](https://en.wikipedia.org/wiki/Simpson_Index) using the `vegan` package as well as the [Richness](https://en.wikipedia.org/wiki/Species_richness) of each sample by counting the number of species that occur, and the [Shannon index](https://en.wikipedia.org/wiki/Diversity_index#Shannon_index). In the `SW` dataset, we have most species combined into one category, despite the various ways of how they are written in the raw data. The remaining non-grouped categories are treated as separate species in the diversity indices, but do not dramatically change the outcome.


```{r Calculate Simpson Index, message=FALSE, warning=FALSE}
library(vegan)
#Diversity Indeces
SW_Div <- SW[,1:2]
#Simpson Index
SW_Div$Simpson <- diversity(SW[,3:154],index="simpson")
#Shannon Index
SW_Div$Shannon <- diversity(SW[,3:154],index="shannon")


#Species Richness
SW_Rich <- SW
SW_Rich$Rich <- rowSums(SW_Rich[,3:154] > 0)
SW_Rich <- data.frame(SW_Rich[,1:2],Richness=SW_Rich$Rich)


```

Lastly we want to compare this to the changes in abundance of *C. fasciatus*, which we can simply extract as percentage from the `SW` layer, by dividing its own weight by the total weight of shells within each sample

```{r}
#Conomurex fasciatus Percentage
SW_CFP <- data.frame(SW[,1:2],"CFP"=100*SW$`Conomurex fasciatus`/rowSums(SW[,3:154]))

```


To make the figure, we need to combine 5 graphs via `patchwork.` The first graph is similar to the ones in the first chapter. The others are simple line plots in `ggplot`. We will again use a for loop for this, which repeats as often as there are sites with changes in aperture size throughout the column.

```{r Suppl. Graphs. 2, fig.height=8, fig.width=18, message=FALSE, warning=FALSE}

#First we need a folder to put things into
dir.create(file.path(dirname("~/capsule/results/Supplementary Material/."), "2. Site-based Diversity"))


library(patchwork)
for (i in 1:length(Apertures[])) {
  
  if (length(Apertures[[i]]) < 2) {#remove trivial sites with only 1 sample
    next
  }

#Aperture Size graph by layer p1
  PLOT1<- ggplot(Aps[Aps$Site==names(Apertures[i]),], aes(
    x = Sample,
    y = Aperture,
    fill = Site,
    colour = Site
  )) +
  geom_flat_violin(
    position = position_nudge(x = +0.25, y = 0),
    adjust = 0.75,
    trim = FALSE,
    alpha = .99
  ) +
  geom_point(position = position_jitter(width = .1), 
             size = 0.05
  ) +
  geom_boxplot(
    position = position_nudge(x = +0.25, y = 0),
    aes(x = Sample, y = Aperture),
    outlier.shape = NA,
    alpha = 0.3,
    width = .1,
    colour = "BLACK"
  ) +
  ylab('Aperture size') + xlab('Sample') + coord_flip() + guides(fill = FALSE, colour = FALSE) +  ylim(10, 35)+
  geom_line(
    data = ApsMeans[ApsMeans$Site==names(Apertures[i]),],
    position = position_nudge(x = +0.25, y = 0),
    aes(x = Sample, y = Aperture_mean, group = Site),
    inherit.aes = FALSE,
    linetype = 3
  ) +
  scale_colour_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +theme(axis.title.x  = element_blank()) +theme_light()+
  ggtitle(paste0(names(Apertures[i])," Aperture size"))



# Graphs for Diversity Indeces                       

## Simpson index
PLOT2 <- ggplot(SW_Div[SW_Div$Site==names(Apertures[i]),], aes(x=Sample, y=Simpson)) +
   coord_flip() + guides(fill = FALSE, colour = FALSE)+
  geom_line(
    aes(x = Sample, y = Simpson,group=1),
    inherit.aes = FALSE, 
    linetype = 1
  ) + ylim(0, 1)+ylab('Simpson Index') + 
  scale_colour_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +theme(axis.title.x  = element_blank()) +theme_light()+
  ggtitle("Simpson Index")

## Shannon index
PLOT3 <- ggplot(SW_Div[SW_Div$Site==names(Apertures[i]),], aes(x=Sample, y=Shannon)) +
   coord_flip() + guides(fill = FALSE, colour = FALSE)+
  geom_line(
    aes(x = Sample, y = Shannon,group=1),
    inherit.aes = FALSE, 
    linetype = 1
  ) +ylim(0, 2.5)+ylab('Shannon Index') + 
  scale_colour_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +theme(axis.title.x  = element_blank()) +theme_light()+
  ggtitle("Shannon Index")



#Graph for Richness


PLOT4 <-  ggplot(SW_Rich[SW_Rich$Site==names(Apertures[i]),], aes(
  x = Sample,
  y = Richness
))+ ylim(0,25)+
  ylab('Richness') + xlab('Sample') + coord_flip() + 
  geom_line(aes(x = Sample, y = Richness, group = Site),
            inherit.aes = FALSE,
            linetype = 1
  ) +
  scale_colour_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +theme(axis.title.x  = element_blank()) +theme_light()+  
  ggtitle("Richness")


#PLOT 5 to draw percentage of C. fasciatus

PLOT5 <-  ggplot(SW_CFP[SW_CFP$Site==names(Apertures[i]),], aes(
  x = Sample,
  y = CFP,fill=Site
))+ 
  ylab(expression('Weight %')) + xlab('Sample') + coord_flip() + 
  geom_area(aes(x = Sample, y = CFP, group = Site),
            inherit.aes = FALSE,
            linetype = 1 ) +
  scale_colour_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +theme(axis.title.x  = element_blank()) +theme_light()+  
  ggtitle(expression('Percentage of'~ italic("C. fasciatus")))


PLOT1+PLOT2+PLOT3+PLOT4+PLOT5+plot_layout(ncol = 5)

setwd("~/capsule/results/Supplementary Material/2. Site-based Diversity")

ggsave(paste0("Diversity_Indeces_in_",names(Apertures[i]),".pdf"),height= 8, width = 18)

}
  
  PLOT1+PLOT2+PLOT3+PLOT4+PLOT5+plot_layout(ncol = 5)

```




# 3. Species ranks by site
Before we start working on the figures we require the dataset for the weights individual ranking of each species within each site (`Ranks`). Before we do that, we need to aggregate the weight data from sample level to site level.

```{r Aggregate Weights to site level}
#Aggregate SW to site level

SW <- aggregate(SW[, 3:154], by = list(SW$Site), FUN = sum)
colnames(SW)[1] <- c("Site")
SW[38, 2:153] <-
  SW[SW$Site == "JW1727_A", 2:153] + SW[SW$Site == "JW1727_B", 2:153] #Sum up each columns' values for species weight
SW <- rbind(SW[1:38, ], SW[40:49, ]) #removing the row for column B
levels(SW$Site) <-
  c(levels(SW$Site), "JW1727")    # adding a new level
SW[38, 1] <-
  "JW1727" #renaming the row of column A to the site's name
```

Now that we have the data structured by site, we can calculate the ranks.


```{r Make Ranks, message=FALSE, warning=FALSE}

#Ranks####
#Before we analyse the rankabundance, we need to move the site description into the rownames, as they are not numeric and will mean that the rankabundance function won't work. Also we need to turn the weights to integer numbers again.
rownames(SW) <- SW[,1]
SW <- round(SW[,2:153])


source('rankabundance.R')

Ranks <- data.frame() #main dataframe
Rank <- data.frame() #single site dataframe used temporarily for each row's loop

for (i in 1:length(SW[,1])) {
  
  Rank<- rankabundance(SW[i,])#make ranking of species abundance. This step will produce a lof of NaNs but that is ok
  Rank <- subset(Rank, Rank[,2] != 0, select=c(rank, abundance, proportion, logabun)) #remove unneccesary colums and rows with species = 0
  Rank <- data.frame(Rank,Site=rep(rownames(SW[i,]),c(length(Rank[,1]))), Species=rownames(Rank))
  
  Ranks <- rbind(Ranks,Rank)
}

rm(Rank,i)#no need for this after the loop is finished
```
Lastly, we determine whether a species is dominant at the site or not using the arbitrary cutoff of 2% by weight

```{r Define dominant species}
Ranks$Dominant <- ifelse(Ranks$proportion <2, "Marginal","Dominant")

```

These dominant species are then highlighted in the figure and their respective names displayed.
These figures are simple point+path scatterplots that make use of the ranks for each species (x-axis) based on weight-percentage (y-axis).


```{r fig.height=5, fig.width=5, message=FALSE, warning=FALSE}

#First we need a folder to put things into
dir.create(file.path(dirname("~/capsule/results/Supplementary Material/."), "3. Species ranks by site"))

for (i in 1:length(rownames(SW))) {
  

PLOT1 <- ggplot(Ranks[Ranks$Site==rownames(SW[i,]),]
                , aes(x=rank,y=proportion, group=Site))+
  geom_path(size=0.5)+
  geom_point(aes(color = Dominant), show.legend = FALSE)+
  scale_color_manual(values=c(viridis_pal()(60)[30],"black"))+
  theme(legend.position = "none")+facet_wrap(~Site,nrow=3)+theme_half_open()+
  theme(strip.background = element_rect(colour = "black", fill = "white"))+
  theme(strip.text.x = element_text(face = "bold"))+scale_y_log10()+xlim(0,20)+
  geom_text_repel(
    data=subset(Ranks[Ranks$Site==rownames(SW[i,]),],proportion>1),
    aes(label= Species, color=factor(Species)),
    xlim = c(10,20),
    colour = viridis_pal()(60)[30],
    direction= "y",
    hjust=0,
    segment.size = 0.1, fontface= 'bold'
  )




PLOT1+plot_annotation(subtitle = "Only names for species with >2% weight percentage displayed" )

setwd("~/capsule/results/Supplementary Material/3. Species ranks by site")
ggsave(paste0("Species_ranks_in_",names(Sites[i]),".pdf"),height= 10, width = 10)

}

PLOT1+plot_annotation(subtitle = "Only names for species with >2% weight percentage displayed" )


```

